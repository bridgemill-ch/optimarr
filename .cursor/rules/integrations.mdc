---
type: Apply to Specific Files
description: Integration patterns for Sonarr, Radarr, and Jellyfin services
globs:
  - "**/Services/*Service.cs"
  - "**/Controllers/*Controller.cs"
  - "**/Services/SonarrService.cs"
  - "**/Services/RadarrService.cs"
  - "**/Services/JellyfinService.cs"
  - "**/Services/ServarrSyncService.cs"
  - "**/Services/VideoServarrMatcherService.cs"
  - "**/Controllers/ServarrController.cs"
  - "**/Controllers/PlaybackController.cs"
---

# Integration Patterns

## Sonarr/Radarr Integration

### Services
- `Services/SonarrService.cs` - HTTP client for Sonarr API
- `Services/RadarrService.cs` - HTTP client for Radarr API
- `Services/ServarrSyncService.cs` - Syncs library paths from Servarr
- `Services/VideoServarrMatcherService.cs` - Matches videos with Servarr metadata

### Path Mapping
- Configured in `appsettings.json` under `Servarr:Sonarr:PathMappings` or `Servarr:Radarr:PathMappings`
- Used to translate paths between Docker containers and host systems
- Applied in `ServarrSyncService.MapPath()`

**Example path mapping in `appsettings.json`:**
```json
{
  "Servarr": {
    "Sonarr": {
      "PathMappings": [
        { "From": "/data/tv", "To": "/mnt/media/tv" }
      ]
    }
  }
}
```

### API Endpoints
- Settings: `GET/POST /api/servarr/sonarr/settings`, `/api/servarr/radarr/settings`
- Sync: `POST /api/servarr/sonarr/sync`, `/api/servarr/radarr/sync`
- Matching: `POST /api/servarr/match-videos`, `GET /api/servarr/match-videos/progress/{matchId}`

**Reference:** See `Controllers/ServarrController.cs` for all endpoints

### Authentication
- Use X-Api-Key header for all Servarr requests
- Optional Basic Authentication support for instances that require it
- Ensure `EnsureApiKeyHeader()` is called in service methods
- Handle timeouts and errors gracefully

**Configuration in `appsettings.json`:**
```json
{
  "Servarr": {
    "Sonarr": {
      "BaseUrl": "http://localhost:8989",
      "ApiKey": "your-api-key",
      "Enabled": true,
      "BasicAuthUsername": "optional-username",
      "BasicAuthPassword": "optional-password"
    }
  }
}
```

**Example from `Services/SonarrService.cs`:**
```csharp
// Basic Auth is automatically added if credentials are provided
if (!string.IsNullOrEmpty(_basicAuthUsername) && !string.IsNullOrEmpty(_basicAuthPassword))
{
    var authValue = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes($"{_basicAuthUsername}:{_basicAuthPassword}"));
    _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Basic", authValue);
}
```

## Jellyfin Integration

### Service
- `Services/JellyfinService.cs` - HTTP client for Jellyfin API
- `Services/PlaybackSyncService.cs` - Background service for syncing playback history

**Reference:** See `Services/JellyfinService.cs` for API communication patterns

### Compatibility Data
- `Services/JellyfinCompatibilityData.cs` - Static compatibility matrix
- Updated based on official Jellyfin client documentation
- Contains codec compatibility ratings for each client

**Reference:** See `Services/JellyfinCompatibilityData.cs` for compatibility matrix structure

### Authentication
- Use X-Emby-Token header for Jellyfin API requests
- Support API key or username/password authentication

**Example from `Services/JellyfinService.cs`:**
```csharp
_httpClient.DefaultRequestHeaders.Add("X-Emby-Token", _apiKey);
// Or authenticate with username/password to get token
```
