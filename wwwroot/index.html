<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimarr - Media Optimization</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="alternate icon" type="image/svg+xml" href="logo.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-wrapper">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay"></div>
        
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="logo.svg" alt="Optimarr Logo" class="logo">
                </div>
                <div class="brand-text">
                    <h1>Optimarr</h1>
                    <span class="subtitle">Media Optimization</span>
                    <span class="version-text" id="appVersion">v1.1.0</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" data-tab="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#browse" class="nav-item" data-tab="browse">
                    <span class="nav-icon">üîç</span>
                    <span class="nav-text">Browse</span>
                </a>
                <a href="#library" class="nav-item" data-tab="library">
                    <span class="nav-icon">üìÅ</span>
                    <span class="nav-text">Library</span>
                    <span class="nav-badge" id="libraryProcessingBadge" style="display: none;">0</span>
                </a>
                <a href="#playback" class="nav-item" data-tab="playback">
                    <span class="nav-icon">‚ñ∂Ô∏è</span>
                    <span class="nav-text">Playback</span>
                </a>
                <a href="#settings" class="nav-item" data-tab="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Database Migration Banner -->
        <div id="migrationBanner" class="migration-banner" style="display: none;">
            <div class="migration-banner-content">
                <div class="migration-banner-icon">üîÑ</div>
                <div class="migration-banner-text">
                    <div class="migration-banner-title">Database Migration in Progress</div>
                    <div class="migration-banner-message" id="migrationMessage">Checking database schema...</div>
                    <div class="migration-banner-details" id="migrationDetails" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <section id="dashboard" class="content-section active">
                <div class="page-header">
                    <h2>Dashboard</h2>
                </div>

                <div class="content-box" id="ratingInfoBox" style="margin-bottom: 1.5rem;">
                    <div class="box-header" style="position: relative;">
                        <button class="info-banner-close" onclick="closeRatingInfoBox()" aria-label="Close" title="Close">
                            <span>√ó</span>
                        </button>
                        <h3>Understanding Compatibility Ratings</h3>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                            The rating shows the number of Jellyfin clients that can Direct Play the video (out of 11 total clients). Higher numbers indicate better compatibility.
                        </p>
                    </div>
                    <div class="box-content">
                        <div class="info-box" style="margin: 0;">
                            <p style="margin: 0 0 0.75rem 0;">Videos are rated based on the number of Jellyfin clients that can Direct Play them (out of 11 total clients):</p>
                            <ul style="margin: 0 0 0.75rem 0; padding-left: 1.5rem;">
                                <li><strong>Optimal (‚úì):</strong> At least <span id="dashboardOptimalThreshold">8</span> clients can <strong>Direct Play</strong> - no server processing needed, best performance</li>
                                <li><strong>Good (~):</strong> At least <span id="dashboardGoodDirectThreshold">5</span> clients can Direct Play, OR at least <span id="dashboardGoodCombinedThreshold">8</span> clients can Direct Play or <strong>Remux</strong> (container change only) - minimal server load</li>
                                <li><strong>Poor (‚úó):</strong> Fewer clients meet the "Good" criteria - may require <strong>Transcoding</strong> (full re-encoding) on many devices, higher server CPU usage</li>
                            </ul>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                <strong>üí° Tip:</strong> You can adjust these thresholds in <a href="#settings" onclick="document.querySelector('[data-tab=settings]').click(); return false;" style="color: var(--primary-color); text-decoration: underline;">Settings</a> to match your needs. Changes only apply to newly scanned videos.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat-box clickable-stat" onclick="navigateToBrowseWithFilter('')" style="cursor: pointer;" title="Click to view all videos">
                        <div class="stat-icon">üé¨</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalVideos">-</div>
                            <div class="stat-label">Total Videos</div>
                        </div>
                    </div>
                    <div class="stat-box optimal clickable-stat" onclick="navigateToBrowseWithFilter('Optimal')" style="cursor: pointer;" title="Click to view all Optimal videos">
                        <div class="stat-icon">‚úì</div>
                        <div class="stat-info">
                            <div class="stat-value" id="optimalCount">-</div>
                            <div class="stat-label">Optimal</div>
                        </div>
                    </div>
                    <div class="stat-box good clickable-stat" onclick="navigateToBrowseWithFilter('Good')" style="cursor: pointer;" title="Click to view all Good videos">
                        <div class="stat-icon">‚ö†</div>
                        <div class="stat-info">
                            <div class="stat-value" id="goodCount">-</div>
                            <div class="stat-label">Good</div>
                        </div>
                    </div>
                    <div class="stat-box poor clickable-stat" onclick="navigateToBrowseWithFilter('Poor')" style="cursor: pointer;" title="Click to view all Poor videos">
                        <div class="stat-icon">‚úó</div>
                        <div class="stat-info">
                            <div class="stat-value" id="poorCount">-</div>
                            <div class="stat-label">Poor</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">üíæ</div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalSize">-</div>
                            <div class="stat-label">Total Size</div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">üé®</div>
                        <div class="stat-info">
                            <div class="stat-value" id="hdrCount">-</div>
                            <div class="stat-label">HDR Videos</div>
                        </div>
                    </div>
                </div>

                <div class="content-box">
                    <div class="box-header">
                        <h3>Compatibility Distribution</h3>
                    </div>
                    <div class="box-content">
                        <div id="compatibilityChart" class="chart-container"></div>
                    </div>
                </div>

                <div class="content-row">
                    <div class="content-box">
                        <div class="box-header">
                            <h3>Video Codecs</h3>
                        </div>
                        <div class="box-content">
                            <div id="codecChart" class="chart-container"></div>
                        </div>
                    </div>
                    <div class="content-box">
                        <div class="box-header">
                            <h3>Containers</h3>
                        </div>
                        <div class="box-content">
                            <div id="containerChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Client Compatibility Dashboard -->
                <div class="content-box">
                    <div class="box-header">
                        <h3>Client Compatibility Overview</h3>
                        <small style="color: var(--text-secondary); font-weight: normal;">Compatibility across all videos in your library</small>
                    </div>
                    <div class="box-content">
                        <div id="clientCompatibilityList" class="client-compatibility-list"></div>
                    </div>
                </div>

                <!-- Jellyfin Clients Section -->
                <div class="content-box" id="jellyfinClientsBox" style="display: none;">
                    <div class="box-header">
                        <h3>üì∫ Jellyfin Clients in Use</h3>
                        <small style="color: var(--text-secondary); font-weight: normal;">Based on playback history</small>
                    </div>
                    <div class="box-content">
                        <div id="jellyfinClients" class="loading-placeholder">Loading clients...</div>
                    </div>
                </div>
            </section>

            <!-- Browse Tab -->
            <section id="browse" class="content-section">
                <div class="page-header">
                    <h2>Browse Media</h2>
                </div>

                <div class="browse-selection-toolbar" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background-color: var(--bg-tertiary); border-radius: 4px; border: 1px solid var(--border-color);">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="selectAllBrowse" onchange="toggleSelectAllBrowse()">
                            <span>Select All (Current Page)</span>
                        </label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllFromAllPages()" title="Select all videos matching current filters from all pages">
                            Select All from All Pages
                        </button>
                        <span id="selectedCount" style="color: var(--text-secondary); font-size: 0.875rem;">0 selected</span>
                        <button type="button" class="btn btn-primary" onclick="rescanSelected()" id="rescanSelectedBtn" disabled>
                            Rescan Selected
                        </button>
                        <button type="button" class="btn btn-primary" onclick="redownloadSelected()" id="redownloadSelectedBtn" disabled>
                            Redownload Selected
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearBrowseSelection()">
                            Clear Selection
                        </button>
                    </div>
                </div>

                <div class="content-box">
                    <div class="box-header">
                        <div class="browse-controls">
                            <div class="browse-filters">
                                <div class="control-section-label">Filters</div>
                                <div class="browse-toolbar">
                                    <select id="browseLibraryFilter" class="form-control">
                                        <option value="">All Libraries</option>
                                    </select>
                                    <select id="browseCodecFilter" class="form-control">
                                        <option value="">All Codecs</option>
                                    </select>
                                    <select id="browseContainerFilter" class="form-control">
                                        <option value="">All Containers</option>
                                    </select>
                                    <select id="browseScoreFilter" class="form-control">
                                        <option value="">All Scores</option>
                                        <option value="Optimal">Optimal</option>
                                        <option value="Good">Good</option>
                                        <option value="Poor">Poor</option>
                                    </select>
                                    <select id="browseServarrFilter" class="form-control">
                                        <option value="">All Media</option>
                                        <option value="synced">Synced with Sonarr/Radarr</option>
                                        <option value="not-synced">Not Synced</option>
                                    </select>
                                    <input type="text" id="browseSearch" class="form-control" placeholder="Search filename, path, codec, container..." onkeypress="if(event.key==='Enter') loadBrowseMedia()">
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                                        <input type="checkbox" id="browseBrokenFilter">
                                        <span>Broken Only</span>
                                    </label>
                                    <button class="btn btn-secondary" onclick="loadBrowseMedia()">Filter</button>
                                </div>
                            </div>
                            <div class="browse-sort">
                                <div class="control-section-label">Sort</div>
                                <div class="browse-toolbar">
                                    <select id="browseSortBy" class="form-control">
                                        <option value="analyzedAt">Date Analyzed</option>
                                        <option value="fileName">Name</option>
                                        <option value="fileSize">File Size</option>
                                        <option value="compatibilityRating">Rating</option>
                                        <option value="duration">Duration</option>
                                        <option value="width">Resolution</option>
                                    </select>
                                    <select id="browseSortOrder" class="form-control">
                                        <option value="desc">Descending</option>
                                        <option value="asc">Ascending</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-content">
                        <div id="browseMediaGrid" class="media-grid">
                            <div class="loading-placeholder">Loading media...</div>
                        </div>
                        <div id="browsePagination" class="pagination"></div>
                    </div>
                </div>
            </section>

            <!-- Playback Tab -->
            <section id="playback" class="content-section">
                <div class="page-header">
                    <h2>Playback History</h2>
                </div>

                <div id="playbackDashboard"></div>

                <div class="content-box">
                    <div class="box-header">
                        <div class="browse-controls">
                            <div class="browse-filters">
                                <div class="control-section-label">Filters</div>
                                <div class="browse-toolbar">
                                    <select id="playbackLibraryFilter" class="form-control">
                                        <option value="">All Libraries</option>
                                    </select>
                                    <select id="playbackMethodFilter" class="form-control">
                                        <option value="">All Methods</option>
                                        <option value="directplay">Direct Play</option>
                                        <option value="directstream">Direct Stream</option>
                                        <option value="transcode">Transcode</option>
                                    </select>
                                    <select id="playbackDeviceFilter" class="form-control">
                                        <option value="">All Devices</option>
                                    </select>
                                    <select id="playbackClientFilter" class="form-control">
                                        <option value="">All Clients</option>
                                    </select>
                                    <select id="playbackUserFilter" class="form-control">
                                        <option value="">All Users</option>
                                    </select>
                                    <input type="text" id="playbackSearch" class="form-control" placeholder="Search item name, path, client, device..." onkeypress="if(event.key==='Enter') loadPlaybackHistory()">
                                    <button class="btn btn-secondary" onclick="loadPlaybackHistory()">Filter</button>
                                </div>
                            </div>
                            <div class="browse-sort">
                                <div class="control-section-label">Sort</div>
                                <div class="browse-toolbar">
                                    <select id="playbackSortBy" class="form-control">
                                        <option value="playbackStartTime">Date</option>
                                        <option value="itemName">Item Name</option>
                                        <option value="playMethod">Play Method</option>
                                        <option value="clientName">Client</option>
                                        <option value="deviceName">Device</option>
                                        <option value="username">User</option>
                                    </select>
                                    <select id="playbackSortOrder" class="form-control">
                                        <option value="desc">Descending</option>
                                        <option value="asc">Ascending</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-content">
                        <div id="playbackHistoryGrid" class="playback-list">
                            <div class="loading-placeholder">Loading playback history...</div>
                        </div>
                        <div id="playbackPagination" class="pagination"></div>
                    </div>
                </div>
            </section>

            <!-- Library Tab -->
            <section id="library" class="content-section">
                <div class="page-header">
                    <h2>Library Management</h2>
                    <button class="btn btn-primary btn-icon" onclick="showAddLibraryModal()" title="Add Library">
                        <span class="btn-icon-text">+</span>
                    </button>
                </div>

                <div class="content-box">
                    <div class="box-header">
                        <h3>Libraries</h3>
                    </div>
                    <div class="box-content">
                        <div id="knownLibraries" class="libraries-grid">
                            <div class="loading-placeholder">Loading libraries...</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Videos (Redownloading) -->
                <div class="content-box">
                    <div class="box-header">
                        <h3>Redownloading Videos</h3>
                        <small style="color: var(--text-secondary); font-weight: normal;">Videos currently being redownloaded will be automatically rescanned after 24 hours</small>
                    </div>
                    <div class="box-content">
                        <div id="processingVideos">
                            <div class="loading-placeholder">Loading processing videos...</div>
                        </div>
                    </div>
                </div>

                <!-- Scan Progress (hidden by default, shown when scanning) -->
                <div id="scanProgress" style="display: none;" class="content-box">
                    <div class="box-header">
                        <h3>Scan Progress</h3>
                    </div>
                    <div class="box-content">
                        <div id="scanProgressContainer">
                            <!-- Multiple scan progress items will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settings" class="content-section">
                <div class="page-header">
                    <h2>Settings</h2>
                </div>

                <div class="content-box">
                    <div class="box-header">
                        <h3>Service Integrations</h3>
                    </div>
                    <div class="box-content">
                        <form id="settingsForm" class="form">
                            <!-- Jellyfin Section -->
                            <div class="settings-section">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                                    <h4 style="margin: 0;">Jellyfin</h4>
                                    <span id="jellyfinStatus" class="status-badge disabled" style="font-size: 0.75rem;">Loading...</span>
                                </div>
                                <div class="info-box" style="margin-bottom: 1rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                    <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                        Configure Jellyfin connection to sync playback history and match with your local libraries. You can use either an API Key or Username/Password for authentication.
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label for="jellyfinUrl">Base URL</label>
                                    <input type="text" id="jellyfinUrl" class="form-control" placeholder="http://localhost:8096">
                                </div>
                                <div class="form-group">
                                    <label for="jellyfinApiKey">API Key (Optional if using Username/Password)</label>
                                    <input type="password" id="jellyfinApiKey" class="form-control" placeholder="Your Jellyfin API Key">
                                    <small class="form-help">Get this from: Dashboard ‚Üí API Keys</small>
                                </div>
                                <div class="form-group">
                                    <label for="jellyfinUsername">Username (Optional if using API Key)</label>
                                    <input type="text" id="jellyfinUsername" class="form-control" placeholder="Your Jellyfin username">
                                </div>
                                <div class="form-group">
                                    <label for="jellyfinPassword">Password (Optional if using API Key)</label>
                                    <input type="password" id="jellyfinPassword" class="form-control" placeholder="Your Jellyfin password">
                                    <small class="form-help">Leave blank to keep current password</small>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="jellyfinEnabled">
                                        <span>Enabled</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                        <button type="button" class="btn btn-secondary" onclick="testJellyfinConnection(event)">
                                            <span id="jellyfinTestStatus"></span> Test Connection
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="saveJellyfinSettings()">
                                            Save Settings
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Sync Options</label>
                                    <div style="display: flex; gap: 0.75rem; align-items: flex-start; flex-wrap: wrap;">
                                        <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                                            <input type="checkbox" id="syncAllHistory" onchange="toggleSyncDaysInput()">
                                            <span>Sync All Historical Data</span>
                                        </label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center; flex: 1; min-width: 200px;">
                                            <input type="number" id="syncDays" class="form-control" value="30" min="1" max="365" style="max-width: 100px;">
                                            <span style="color: var(--text-secondary); font-size: 0.875rem;">days</span>
                                        </div>
                                    </div>
                                    <small class="form-help" style="margin-top: 0.5rem; display: block;">
                                        <span id="syncHelpText">Import playback history from the last 30 days. Check "Sync All" to import complete history.</span>
                                    </small>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="syncJellyfinPlayback(event)">
                                            <span id="jellyfinSyncStatus"></span> Sync Playback History
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="rematchPlaybackHistory(event)" title="Re-match existing playback history with libraries (useful if libraries were added after sync)">
                                            Re-match with Libraries
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Sonarr Section -->
                            <div class="settings-section">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                                    <h4 style="margin: 0;">Sonarr</h4>
                                    <span id="sonarrStatusText" class="status-badge disabled" style="font-size: 0.75rem;">Loading...</span>
                                </div>
                                <div class="info-box" style="margin-bottom: 1rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                    <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                        Configure Sonarr connection to sync TV show libraries and automatically discover series. Get your API key from Settings ‚Üí General ‚Üí Security ‚Üí API Key.
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label for="sonarrUrl">Base URL</label>
                                    <input type="text" id="sonarrUrl" class="form-control" placeholder="http://localhost:8989">
                                </div>
                                <div class="form-group">
                                    <label for="sonarrApiKey">API Key</label>
                                    <input type="password" id="sonarrApiKey" class="form-control" placeholder="Your Sonarr API Key">
                                    <small class="form-help">Get this from: Settings ‚Üí General ‚Üí Security ‚Üí API Key</small>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="sonarrEnabled">
                                        <span>Enabled</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                        <button type="button" class="btn btn-secondary" onclick="testSonarrConnection(event)">
                                            <span id="sonarrTestStatus"></span> Test Connection
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="saveSonarrSettings()">
                                            Save Settings
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Path Mappings</label>
                                    <div class="info-box" style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                            Map paths from Sonarr to Optimarr. Required if Sonarr and Optimarr run in different Docker containers or see different paths. Example: Sonarr sees <code>/data/tv</code> but Optimarr needs <code>/mnt/media/tv</code>.
                                        </p>
                                    </div>
                                    <div id="sonarrPathMappingsContainer">
                                        <div class="loading-placeholder">Loading path mappings...</div>
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="addSonarrPathMapping()">+ Add Mapping</button>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="saveSonarrPathMappings()">Save Mappings</button>
                                    </div>
                                </div>
                                <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Library Sync</label>
                                    <div class="info-box" style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                            Sync Sonarr root folders and series to Optimarr's internal library. This will automatically discover and add TV show libraries from Sonarr.
                                        </p>
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="syncSonarrLibrary()">
                                            <span id="sonarrSyncStatus"></span> Sync Sonarr Library
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="matchVideosWithServarr()" title="Match existing videos in Optimarr with Sonarr series">
                                            <span id="matchVideosStatusSonarr"></span> Match Videos
                                        </button>
                                    </div>
                                    <div id="sonarrSyncResult" style="margin-top: 0.75rem; display: none;"></div>
                                </div>
                            </div>

                            <!-- Radarr Section -->
                            <div class="settings-section">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                                    <h4 style="margin: 0;">Radarr</h4>
                                    <span id="radarrStatusText" class="status-badge disabled" style="font-size: 0.75rem;">Loading...</span>
                                </div>
                                <div class="info-box" style="margin-bottom: 1rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                    <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                        Configure Radarr connection to sync movie libraries and automatically discover movies. Get your API key from Settings ‚Üí General ‚Üí Security ‚Üí API Key.
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label for="radarrUrl">Base URL</label>
                                    <input type="text" id="radarrUrl" class="form-control" placeholder="http://localhost:7878">
                                </div>
                                <div class="form-group">
                                    <label for="radarrApiKey">API Key</label>
                                    <input type="password" id="radarrApiKey" class="form-control" placeholder="Your Radarr API Key">
                                    <small class="form-help">Get this from: Settings ‚Üí General ‚Üí Security ‚Üí API Key</small>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="radarrEnabled">
                                        <span>Enabled</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                        <button type="button" class="btn btn-secondary" onclick="testRadarrConnection(event)">
                                            <span id="radarrTestStatus"></span> Test Connection
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="saveRadarrSettings()">
                                            Save Settings
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Path Mappings</label>
                                    <div class="info-box" style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                            Map paths from Radarr to Optimarr. Required if Radarr and Optimarr run in different Docker containers or see different paths. Example: Radarr sees <code>/data/movies</code> but Optimarr needs <code>/mnt/media/movies</code>.
                                        </p>
                                    </div>
                                    <div id="radarrPathMappingsContainer">
                                        <div class="loading-placeholder">Loading path mappings...</div>
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="addRadarrPathMapping()">+ Add Mapping</button>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="saveRadarrPathMappings()">Save Mappings</button>
                                    </div>
                                </div>
                                <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Library Sync</label>
                                    <div class="info-box" style="margin-bottom: 0.75rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                            Sync Radarr root folders and movies to Optimarr's internal library. This will automatically discover and add movie libraries from Radarr.
                                        </p>
                                    </div>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="syncRadarrLibrary()">
                                            <span id="radarrSyncStatus"></span> Sync Radarr Library
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="matchVideosWithServarr()" title="Match existing videos in Optimarr with Radarr movies">
                                            <span id="matchVideosStatusRadarr"></span> Match Videos
                                        </button>
                                    </div>
                                    <div id="radarrSyncResult" style="margin-top: 0.75rem; display: none;"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Rating Thresholds Section -->
                <div class="content-box" style="margin-top: 1.5rem;">
                    <div class="box-header">
                        <h3>Rating Thresholds</h3>
                    </div>
                    <div class="box-content">
                        <form id="ratingSettingsForm" class="form">
                            <div class="settings-section">
                                <h4 style="margin-top: 0; margin-bottom: 1rem;">Global Rating Thresholds</h4>
                                <div class="info-box" style="margin-bottom: 1.5rem; padding: 1rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">Rating thresholds:</p>
                                    <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary);">
                                        <li><strong>Optimal:</strong> At least <span id="currentOptimalThreshold">8</span> clients can Direct Play</li>
                                        <li><strong>Good:</strong> At least <span id="currentGoodDirectThreshold">5</span> clients can Direct Play, OR at least <span id="currentGoodCombinedThreshold">8</span> clients can Direct Play or Remux combined</li>
                                        <li><strong>Poor:</strong> Fewer clients meet the "Good" criteria</li>
                                    </ul>
                                </div>
                                <div class="form-group">
                                    <label for="optimalThreshold">Optimal Rating Threshold (Direct Play clients)</label>
                                    <input type="number" id="optimalThreshold" class="form-control" min="1" max="20" step="1">
                                    <small class="form-help">Minimum number of clients that must support Direct Play for "Optimal" rating</small>
                                </div>
                                <div class="form-group">
                                    <label for="goodDirectThreshold">Good Rating Threshold - Direct Play (clients)</label>
                                    <input type="number" id="goodDirectThreshold" class="form-control" min="1" max="20" step="1">
                                    <small class="form-help">Minimum Direct Play clients for "Good" rating (if combined threshold not met)</small>
                                </div>
                                <div class="form-group">
                                    <label for="goodCombinedThreshold">Good Rating Threshold - Combined (Direct Play + Remux clients)</label>
                                    <input type="number" id="goodCombinedThreshold" class="form-control" min="1" max="20" step="1">
                                    <small class="form-help">Minimum combined Direct Play + Remux clients for "Good" rating</small>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Save Rating Settings</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Jellyfin Clients Section -->
                <div class="content-box" style="margin-top: 1.5rem;">
                    <div class="box-header">
                        <h3>Jellyfin Clients</h3>
                    </div>
                    <div class="box-content">
                        <div class="settings-section">
                            <div class="info-box" style="margin-bottom: 1rem; padding: 0.75rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                    Enable or disable Jellyfin clients for compatibility calculations. Disabled clients will not be included in the compatibility rating (0-11 scale) or Client Compatibility Overrides. This allows you to focus on the clients you actually use.
                                </p>
                            </div>
                            <div id="clientSettingsContainer">
                                <div class="loading-placeholder">Loading client settings...</div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button type="button" class="btn btn-primary" onclick="saveClientSettings()">Save Client Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compatibility Overrides Section -->
                <div class="content-box" style="margin-top: 1.5rem;">
                    <div class="box-header">
                        <h3>Client Compatibility Overrides</h3>
                    </div>
                    <div class="box-content">
                        <div class="settings-section">
                            <div class="info-box" style="margin-bottom: 1.5rem; padding: 1rem; background-color: var(--bg-secondary); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                                    Override default compatibility settings for specific codecs and clients. Changes will apply to newly analyzed videos. Use this to customize compatibility based on your specific client devices and versions.
                                </p>
                            </div>
                            <div id="compatibilitySettingsContainer">
                                <div class="loading-placeholder">Loading compatibility settings...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Media Info Modal -->
    <div id="mediaInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalMediaTitle">Media Information</h3>
                <button class="modal-close" onclick="closeMediaModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalMediaContent">
                <div class="loading-placeholder">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add Library Modal -->
    <div id="addLibraryModal" class="modal">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Add Library</h3>
                <button class="modal-close" onclick="closeAddLibraryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addLibraryForm" class="form">
                    <div class="form-group">
                        <label for="newLibraryName">Library Name</label>
                        <input type="text" id="newLibraryName" class="form-control" placeholder="My Video Library" required>
                    </div>
                    <div class="form-group">
                        <label for="newLibraryPath">Library Path</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="newLibraryPath" class="form-control" placeholder="/path/to/videos" required style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="showPathBrowser()" style="white-space: nowrap;">Browse</button>
                        </div>
                        <small class="form-help">Enter a server path or use Browse to navigate directories</small>
                    </div>
                    <div class="form-group">
                        <label for="newLibraryCategory">Category</label>
                        <select id="newLibraryCategory" class="form-control" required>
                            <option value="Misc">Misc</option>
                            <option value="Movies">Movies</option>
                            <option value="TV Shows">TV Shows</option>
                        </select>
                        <small class="form-help">Category helps organize your libraries</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddLibraryModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add & Scan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Path Browser Modal -->
    <div id="pathBrowserModal" class="modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h3>Browse Directory</h3>
                <button class="modal-close" onclick="closePathBrowser()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button type="button" class="btn btn-secondary" onclick="navigatePathBrowser('..')" id="pathBrowserUp" style="white-space: nowrap;">‚Üë Up</button>
                        <input type="text" id="pathBrowserCurrent" class="form-control" readonly style="flex: 1; background-color: var(--bg-secondary);">
                    </div>
                </div>
                <div id="pathBrowserContent" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.5rem;">
                    <div class="loading-placeholder">Loading directories...</div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 8px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePathBrowser()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="selectPathFromBrowser()">Select This Path</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Compatibility Modal -->
    <div id="clientCompatibilityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clientCompatibilityTitle">Client Compatibility</h3>
                <button class="modal-close" onclick="closeClientCompatibilityModal()">&times;</button>
            </div>
            <div class="modal-body" id="clientCompatibilityContent">
                <div class="loading-placeholder">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Track Details Modal -->
    <div id="trackDetailsModal" class="modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h3 id="trackDetailsTitle">Track Details</h3>
                <button class="modal-close" onclick="closeTrackDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="trackDetailsContent">
                <div class="loading-placeholder">Loading track details...</div>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>
    <!-- Suppress ASP.NET Core browser refresh WebSocket errors in console -->
    <script>
        // Suppress WebSocket connection errors from ASP.NET Core browser refresh
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('WebSocket') && e.message.includes('aspnetcore-browser-refresh')) {
                e.preventDefault();
                return false;
            }
        }, true);
        
        // Also catch unhandled promise rejections from WebSocket
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && typeof e.reason === 'string' && e.reason.includes('WebSocket') && e.reason.includes('aspnetcore-browser-refresh')) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
